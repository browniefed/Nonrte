!function(a){var b=function(){var a,b=[];b=["~","`","!","@","#","$","%","^","&","*","(",")","{","}","[","]","_","-","+","=",":",";",'"',"'","<",",",">",".","?","/","|","\\"];for(var c=0;10>c;c++)b.push(""+c);for(var c=65;90>=c;c++)a=String.fromCharCode(c).toLowerCase(),b.push("shift+"+a),b.push(a);return b}(),c=function(a){return a}(b),d=function(){var a;return a=function(a,b){function c(a,b,c){return a.addEventListener?void a.addEventListener(b,c,!1):void a.attachEvent("on"+b,c)}function d(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);return a.shiftKey||(b=b.toLowerCase()),b}return y[a.which]?y[a.which]:z[a.which]?z[a.which]:String.fromCharCode(a.which).toLowerCase()}function e(a,b){return a.sort().join(",")===b.sort().join(",")}function f(a){a=a||{};var b,c=!1;for(b in E)a[b]?c=!0:E[b]=0;c||(H=!1)}function g(a,b,c,d,f,g){var h,i,j=[],k=c.type;if(!C[a])return[];for("keyup"==k&&n(a)&&(b=[a]),h=0;h<C[a].length;++h)if(i=C[a][h],(d||!i.seq||E[i.seq]==i.level)&&k==i.action&&("keypress"==k&&!c.metaKey&&!c.ctrlKey||e(b,i.modifiers))){var l=!d&&i.combo==f,m=d&&i.seq==d&&i.level==g;(l||m)&&C[a].splice(h,1),j.push(i)}return j}function h(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function i(a){return a.preventDefault?void a.preventDefault():void(a.returnValue=!1)}function j(a){return a.stopPropagation?void a.stopPropagation():void(a.cancelBubble=!0)}function k(a,b,c,d){J.stopCallback(b,b.target||b.srcElement,c,d)||a(b,c)===!1&&(i(b),j(b))}function l(a,b,c){var d,e=g(a,b,c),h={},i=0,j=!1;for(d=0;d<e.length;++d)e[d].seq&&(i=Math.max(i,e[d].level));for(d=0;d<e.length;++d)if(e[d].seq){if(e[d].level!=i)continue;j=!0,h[e[d].seq]=1,k(e[d].callback,c,e[d].combo,e[d].seq)}else j||k(e[d].callback,c,e[d].combo);var l="keypress"==c.type&&G;c.type!=H||n(a)||l||f(h),G=j&&"keydown"==c.type}function m(a){"number"!=typeof a.which&&(a.which=a.keyCode);var b=d(a);if(b)return"keyup"==a.type&&F===b?void(F=!1):void J.handleKey(b,h(a),a)}function n(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function o(){clearTimeout(x),x=setTimeout(f,1e3)}function p(){if(!w){w={};for(var a in y)a>95&&112>a||y.hasOwnProperty(a)&&(w[y[a]]=a)}return w}function q(a,b,c){return c||(c=p()[a]?"keydown":"keypress"),"keypress"==c&&b.length&&(c="keydown"),c}function r(a,b,c,e){function g(b){return function(){H=b,++E[a],o()}}function h(b){k(c,b,a),"keyup"!==e&&(F=d(b)),setTimeout(f,10)}E[a]=0;for(var i=0;i<b.length;++i){var j=i+1===b.length,l=j?h:g(e||t(b[i+1]).action);u(b[i],l,e,a,i)}}function s(a){return"+"===a?["+"]:a.split("+")}function t(a,b){var c,d,e,f=[];for(c=s(a),e=0;e<c.length;++e)d=c[e],B[d]&&(d=B[d]),b&&"keypress"!=b&&A[d]&&(d=A[d],f.push("shift")),n(d)&&f.push(d);return b=q(d,f,b),{key:d,modifiers:f,action:b}}function u(a,b,c,d,e){D[a+":"+c]=b,a=a.replace(/\s+/g," ");var f,h=a.split(" ");return h.length>1?void r(a,h,b,c):(f=t(a,c),C[f.key]=C[f.key]||[],g(f.key,f.modifiers,{type:f.action},d,a,e),void C[f.key][d?"unshift":"push"]({callback:b,modifiers:f.modifiers,action:f.action,seq:d,level:e,combo:a}))}function v(a,b,c){for(var d=0;d<a.length;++d)u(a[d],b,c)}for(var w,x,y={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},z={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},A={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},B={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},C={},D={},E={},F=!1,G=!1,H=!1,I=1;20>I;++I)y[111+I]="f"+I;for(I=0;9>=I;++I)y[I+96]=I;c(b,"keypress",m),c(b,"keydown",m),c(b,"keyup",m);var J={bind:function(a,b,c){return a=a instanceof Array?a:[a],v(a,b,c),this},unbind:function(a,b){return J.bind(a,function(){},b)},trigger:function(a,b){return D[a+":"+b]&&D[a+":"+b]({},a),this},reset:function(){return C={},D={},this},stopCallback:function(a,b){return(" "+b.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},handleKey:l};return J}(window,document)}(),e=function(){function a(a){var b;for(b in a)if(a.hasOwnProperty(b))return!0;return!1}function b(a){return function(){throw a}}function c(a,c,d){try{a(c,d)}catch(e){setTimeout(b(e),0)}}function d(a,b,c){a(b,c)}function e(a,b,e,f){var g,h=j[b],i=f?d:c;if(j.hasOwnProperty(b))for(g in h)h.hasOwnProperty(g)&&i(h[g],a,e)}function f(a,b,c){return function(){var d=String(a),f=d.lastIndexOf(".");for(e(a,a,b,c);-1!==f;)d=d.substr(0,f),f=d.lastIndexOf("."),e(a,d,b)}}function g(b){for(var c=String(b),d=Boolean(j.hasOwnProperty(c)&&a(j[c])),e=c.lastIndexOf(".");!d&&-1!==e;)c=c.substr(0,e),e=c.lastIndexOf("."),d=Boolean(j.hasOwnProperty(c)&&a(j[c]));return d}function h(a,b,c,d){var e=f(a,b,d),h=g(a);return h?(c===!0?e():setTimeout(e,0),!0):!1}var i={},j={},k=-1;return i.publish=function(a,b){return h(a,b,!1,i.immediateExceptions)},i.publishSync=function(a,b){return h(a,b,!0,i.immediateExceptions)},i.subscribe=function(a,b){if("function"!=typeof b)return!1;j.hasOwnProperty(a)||(j[a]={});var c="uid_"+String(++k);return j[a][c]=b,c},i.unsubscribe=function(a){var b,c,d,e="string"==typeof a,f=!1;for(b in j)if(j.hasOwnProperty(b)){if(c=j[b],e&&c[a]){delete c[a],f=a;break}if(!e)for(d in c)c.hasOwnProperty(d)&&c[d]===a&&(delete c[d],f=!0)}return f},i}(),f=function(a,b,c){var d=function(){};return d.prototype.init=function(){this.attachGenericKeys(),this.keyHandlers=[]},d.prototype.attachGenericKeys=function(){b.bind(a,this.emitKey.bind(this),"keypress"),b.bind("space",this.emitSpace.bind(this)),b.bind("backspace",this.emitBackspace.bind(this)),b.bind("enter",this.emitEnter.bind(this)),b.bind("up",this.emitUp.bind(this)),b.bind("down",this.emitDown.bind(this)),b.bind("left",this.emitLeft.bind(this)),b.bind("right",this.emitRight.bind(this))},d.prototype.registerKeyHandler=function(a){this.keyHandlers.push(a)},d.prototype.emitKey=function(a){c.publish("keypress.character",String.fromCharCode(a.which))},d.prototype.emitSpace=function(a){c.publish("keypress.spacebar",a)},d.prototype.emitBackspace=function(a){c.publish("keypress.backspace",a)},d.prototype.emitEnter=function(a){c.publish("keypress.enter",a)},d.prototype.emitUp=function(a){c.publish("keypress.up",a)},d.prototype.emitDown=function(a){c.publish("keypress.down",a)},d.prototype.emitLeft=function(a){c.publish("keypress.left",a)},d.prototype.emitRight=function(a){c.publish("keypress.right",a)},d.prototype,d}(c,d,e),g=function(){var a=function(a,b){a.addEventListener("click",b,!1)};return a}(),h=function(){var a=function(){var a=0,b={},c=function(c){var d,e,f,g,h,i=0,j=0,k=0;d=document.createDocumentFragment(),e=document.createElement("div"),e.style="width: 6000px; visibility:hidden",f=document.createElement("span"),f.style=c,g=document.createElement("span"),g.appendChild(document.createTextNode("i")),e.appendChild(f),d.appendChild(e),document.body.appendChild(d),f.appendChild(document.createTextNode("f")),f.appendChild(g),i=f.offsetWidth,f.insertBefore(document.createTextNode(" "),g),j=i,i=f.offsetWidth,k=i-j+.4,b["_ "]=k;for(var l=33;126>=l;l++)h=String.fromCharCode(l),f.insertBefore(document.createTextNode(""+h+h),g),j=i,i=f.offsetWidth,k=(i-j)/2,b["_"+h]=k,a<b["_"+h]&&(a=b["_"+h]);document.body.removeChild(e)};c();var d=function(c){return b["_"+c]?b["_"+c]:(b["_"+c]=a,a)};return{getCharacterWidth:d}}();return a}(),i=function(a){var b=function(b,c){var d=0,e=0,f=0,g=0;return b.split("").forEach(function(b,h){e=a.getCharacterWidth(b),d+e<c.x&&(d+=e,f=d+e,g=h)}),{offsetX:f,clickedCharacter:g}};return b}(h),j=function(a,b,c){var d=function(b){return this.linePosition=b,this.node=document.createElement("div"),this.innerLine=document.createElement("div"),this.innerLine.classList.add("nonrte-line-inner"),this.node.classList.add("nonrte-line"),this.textNode=document.createTextNode(""),this.node.appendChild(this.innerLine),this.innerLine.appendChild(this.textNode),a(this.innerLine,this.lineClickHandle.bind(this)),this};return d.prototype.getNode=function(){return this.node},d.prototype.getTextNode=function(){return this.textNode},d.prototype.getPosition=function(){return this.linePosition},d.prototype.lineClickHandle=function(a){var d=b(this.textNode.data,{x:a.offsetX,y:a.offsetY});d.offsetX+=2;var e={line:this,original:a,offsets:{x:a.offsetX,y:a.offsetY},characterOffset:d};c.publish("lineClick",e)},d}(g,i,e),k=function(a){var b=function(a){this.el=a,this.lines=[]};return b.prototype.createLine=function(){var b=new a(this.lines.length);return this.lines.push(b),this.el.appendChild(b.getNode()),b},b.prototype.getLine=function(a){return this.lines[a]},b.prototype.getLines=function(){return this.lines},b}(j),l=function(a){var b={standard:"nonrte-cursor",focus:"blink",hidden:"hidden"},c=function(){this.cursorNode=document.createElement("div"),this.cursorNode.classList.add(b.standard),this.cursorNode.classList.add(b.focus)};return c.prototype.positionOnLine=function(a,b){a.getNode().appendChild(this.cursorNode),"number"==typeof b&&this.moveToCharacterPosition(a,b)},c.prototype.position=function(a){this.cursorNode.style.left=a+"px"},c.prototype.moveToCharacterPosition=function(b,c){var d=b.getTextNode().data.split(""),e=0;d.forEach(function(b,d){c>d&&(e+=a.getCharacterWidth(b))}),this.position(e)},c.prototype.hide=function(){this.cursorNode.classList.add("hidden")},c.prototype.show=function(){this.cursorNode.classList.remove("hidden")},c}(h),m=function(){var a=function(){};return a}(h),n=function(){var a=function(){this.lines=[]};return a.prototype.addCharacterToLineEnd=function(){},a.prototype.addCharacterToPositionOnLine=function(){},a.prototype.export=function(){},a}(e),o=function(a,b,c,d,e,f){var g=function(g){this.element=g,this.keyhandler=new a,this.lineHandler=new b(this.element),this.cursor=new c,this.data=new f,this.focusPosition={line:0,character:0},d(this),this.cursor.positionOnLine(this.lineHandler.createLine()),this.keyhandler.init(),e.subscribe("keypress.backspace",function(){var a=this.lineHandler.getLine(this.focusPosition.line),b=a.getTextNode();b&&b.length&&this.focusPosition.character-1>=0?(this.focusPosition.character--,b.deleteData(this.focusPosition.character,1)):b&&this.focusPosition.line-1>=0&&(this.focusPosition.line&&this.focusPosition.line--,a=this.lineHandler.getLine(this.focusPosition.line),this.focusPosition.character=a.getTextNode().data.length),this.cursor.positionOnLine(a,this.focusPosition.character)}.bind(this)),e.subscribe("keypress.enter",function(){this.cursor.positionOnLine(this.lineHandler.createLine(),0),this.focusPosition.character=0,this.focusPosition.line=this.lineHandler.getLines().length-1}.bind(this)),e.subscribe("keypress.spacebar",function(a,b){b.preventDefault(),e.publish("keypress.character"," ")}.bind(this)),e.subscribe("keypress.character",function(a,b){var c=this.lineHandler.getLine(this.focusPosition.line).getTextNode();c.insertData(this.focusPosition.character,b),this.focusPosition.character++,this.cursor.moveToCharacterPosition(this.lineHandler.getLine(this.focusPosition.line),this.focusPosition.character)}.bind(this)),e.subscribe("lineClick",function(a,b){this.focusPosition.character=b.characterOffset.clickedCharacter,this.focusPosition.line=b.line.getPosition(),this.cursor.positionOnLine(b.line,this.focusPosition.character)}.bind(this))};return g.prototype.registerKey=function(a,b){this.keyHandler.registerKeyListener(a,b)},g.prototype.registerKeySequence=function(){},g.prototype.registerKeyObserveTrigger=function(a,b){return this.keyHandler.registerKeyListener(a,b),{stop:function(){}}},g}(f,k,l,m,e,n),p=function(a){return a}(o);"undefined"!=typeof module&&module.exports?module.exports=p:"function"==typeof define&&define.amd?define(function(){return p}):a.NonRTE=p}("undefined"!=typeof window?window:this);